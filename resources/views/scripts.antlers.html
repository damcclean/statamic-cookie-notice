<!-- Start: Cookie Notice scripts -->
<script>
    let cookiesForm = document.getElementById('cookiesForm')
    let hideConsentFormButton = document.getElementById('hideConsentFormButton')
    let manageCookiesButton = document.getElementById('manageCookiesButton')
    let COOKIE_NAME = '{{ cookie_name }}'
    let groups = JSON.parse('{{ groups | json }}')

    window.cookieNotice = {
        consentWithCookies: function(groups) {
            this.setCookie(COOKIE_NAME, groups, 30)
            this.hideConsentNotice()
        },

        showConsentNotice: function() {
            manageCookiesButton.setAttribute('style', 'display: none;')
            cookiesForm.removeAttribute('style')
        },

        hideConsentNotice: function() {
            manageCookiesButton.removeAttribute('style')
            cookiesForm.setAttribute('style', 'display: none;')
        },

        cookieExists: function(name) {
            return document.cookie.indexOf(name + '=') !== -1
        },

        getCookie: function(name) {
            const value = `; ${document.cookie}`
            const parts = value.split(`; ${name}=`)
            if (parts.length === 2) return parts.pop().split(';').shift()
        },

        setCookie: function(name, value, expirationInDays) {
            const date = new Date()
            date.setTime(date.getTime() + (expirationInDays * 24 * 60 * 60 * 1000))

            document.cookie = name + '=' + value +
                ';expires=' + date.toUTCString() +
                ';domain={{ domain }}' +
                ';path=/{{ config:session:secure ? ';secure' : null }}' +
                '{{ if config:session:same_site }};samesite={{ config:session:same_site }}{{ /if }}'
        },

        hasConsent: function(group) {
            if (window.cookieNotice.getCookie(COOKIE_NAME) === undefined) {
                return false
            }

            const consented = window.cookieNotice.getCookie(COOKIE_NAME).split(',')

            if (group = groups.find(g => g.name === group)) {
                return consented.includes(group.slug)
            }

            return consented.length > 0
        }
    }

    window.addEventListener('load', function() {
        cookiesForm = document.getElementById('cookiesForm')
        hideConsentFormButton = document.getElementById('hideConsentFormButton')
        manageCookiesButton = document.getElementById('manageCookiesButton')
        COOKIE_NAME = '{{ cookie_name }}'
        groups = JSON.parse('{{ groups | json }}')

        cookiesForm.addEventListener('submit', function(event) {
            event.preventDefault()
            const formData = new FormData(event.target)
            const groups = formData.getAll('groups')

            window.cookieNotice.consentWithCookies(groups)
        })

        cookiesForm.addEventListener('submit', function(event) {
            event.preventDefault()
            const formData = new FormData(event.target)
            const groups = formData.getAll('groups')

            window.cookieNotice.consentWithCookies(groups)
        })

        if (!window.cookieNotice.cookieExists(COOKIE_NAME)) {
            window.cookieNotice.showConsentNotice()
            hideConsentFormButton.setAttribute('style', 'display: none;')
        } else {
            const groups = window.cookieNotice.getCookie(COOKIE_NAME).split(',')

            for (let i = 0; i < groups.length; i++) {
                document.getElementById(groups[i]).setAttribute('checked', true)
            }
        }

        hideConsentFormButton.addEventListener('click', window.cookieNotice.hideConsentNotice)
        manageCookiesButton.addEventListener('click', window.cookieNotice.showConsentNotice)
    })
</script>
<!-- End: Cookie Notice scripts -->
